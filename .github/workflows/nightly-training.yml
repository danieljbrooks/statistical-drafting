name: Nightly Data Update Check

on:
  schedule:
    # Run at 3:00 AM UTC daily
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      force_notification:
        description: 'Force notification even if no new data'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'

jobs:
  check-and-notify:
    name: Check for Data Updates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install requests playwright
          playwright install chromium
          playwright install-deps chromium

      - name: Check for data updates
        id: check
        working-directory: model_refresh
        run: |
          python ci_check_updates.py
        env:
          FORCE_NOTIFICATION: ${{ github.event.inputs.force_notification }}

      - name: Create GitHub Issue for new data
        if: steps.check.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        env:
          LATEST_SET: ${{ steps.check.outputs.latest_set }}
          PREMIER_UPDATED: ${{ steps.check.outputs.premier_updated }}
          TRADITIONAL_UPDATED: ${{ steps.check.outputs.traditional_updated }}
          PICKTWODRAFT_UPDATED: ${{ steps.check.outputs.picktwodraft_updated }}
          ISSUE_BODY: ${{ steps.check.outputs.issue_body }}
        with:
          script: |
            const latestSet = process.env.LATEST_SET;
            const issueBody = process.env.ISSUE_BODY;

            // Create the issue
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `New data available for ${latestSet}`,
              body: issueBody,
              labels: ['data-update']
            });

            core.info(`Created issue #${issue.data.number}: ${issue.data.html_url}`);

      - name: Commit updated tracker
        if: steps.check.outputs.has_updates == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: Update data tracker after detecting new data"
          file_pattern: 'model_refresh/data_tracker.json'
          commit_user_name: github-actions[bot]
          commit_user_email: github-actions[bot]@users.noreply.github.com
